name: Ubuntu VPS with Playit Tunnel

on:
  workflow_dispatch:

jobs:
  setup-ubuntu-vps:
    runs-on: ubuntu-latest

    steps:
    - name: Check out repository
      uses: actions/checkout@v2

    - name: Update system and install required packages
      run: |
        sudo apt update
        sudo apt install -y openssh-server jq curl

    - name: Configure SSH
      run: |
        sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
        sudo service ssh start
        echo "root:p@ssw0rd!" | sudo chpasswd
        
    - name: Download and Install Playit
      run: |
        wget https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-linux-amd64
        chmod +x playit-linux-amd64
        sudo mv playit-linux-amd64 /usr/local/bin/playit

    - name: Start Playit and Set Up SSH Tunnel
      env:
        PLAYIT_AUTH_KEY: ${{ secrets.PL }}
      run: |
        # Start playit in background and redirect output to a file
        playit --secret ${{ secrets.PL }} > playit.log 2>&1 &
        
        # Wait for tunnel to be established
        sleep 30
        
        # Extract SSH tunnel details
        echo "::notice::ğŸ” SSH Access Details:"
        echo "::notice::â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "::notice::ğŸ‘¤ Username: root"
        echo "::notice::ğŸ”‘ Password: p@ssw0rd!"
        
        # Get and display the SSH address
        TUNNEL_ADDRESS=$(curl -s http://localhost:33182/api/tunnels | jq -r '.tunnels[] | select(.proto=="tcp" and .dst_port==22) | "\(.addr):\(.port)"')
        echo "::notice::ğŸŒ SSH Command: ssh root@$TUNNEL_ADDRESS"
        echo "::notice::â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
    - name: Keep Action Runner Alive
      run: |
        # Keep alive for ~3 hours
        sleep 10800
